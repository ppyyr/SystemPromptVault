function co(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function o(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=o(a);fetch(a.href,s)}})();function $e(e,t=!1){return window.__TAURI_INTERNALS__.transformCallback(e,t)}async function X(e,t={},o){return window.__TAURI_INTERNALS__.invoke(e,t,o)}const u=async(e,t={})=>{try{return await X(e,t)}catch(o){throw console.error("调用命令 ".concat(e," 失败:"),o),o}},Ue={getAll:()=>u("get_all_prompts"),getById:e=>u("get_prompt_by_id",{id:e}),getByTags:e=>u("get_prompts_by_tags",{tags:e}),create:(e,t,o)=>u("create_prompt",{name:e,content:t,tags:o}),update:(e,t,o,n)=>u("update_prompt",{id:e,name:t,content:o,tags:n}),delete:e=>u("delete_prompt",{id:e}),exportPrompts:()=>u("export_prompts"),importPrompts:e=>u("import_prompts",{jsonData:e})},Ve={getAll:()=>u("get_all_clients"),getById:e=>u("get_client_by_id",{id:e}),add:(e,t,o)=>u("add_custom_client",{id:e,name:t,configFilePath:o}),update:(e,t,o,n)=>u("update_client",{id:e,name:t,configFilePath:o,autoTag:n}),delete:e=>u("delete_client",{id:e})},j={read:e=>u("read_config_file",{clientId:e}),write:(e,t)=>u("write_config_file",{clientId:e,content:t})},Te={get:()=>u("get_app_state"),setCurrentClient:e=>u("set_current_client",{clientId:e})},R={create:(e,t,o,n)=>u("create_snapshot",{clientId:e,name:t,content:o,isAuto:n}),getAll:e=>u("get_snapshots",{clientId:e}),restore:(e,t)=>u("restore_snapshot",{clientId:e,snapshotId:t}),delete:(e,t)=>u("delete_snapshot",{clientId:e,snapshotId:t}),rename:(e,t,o)=>u("rename_snapshot",{clientId:e,snapshotId:t,newName:o}),setMaxSnapshots:(e,t)=>u("set_max_snapshots",{clientId:e,max:t}),refreshTrayMenu:()=>u("refresh_tray_menu")},ce=3600;let x=0,z,_=null;const Z=e=>{const t=document.getElementById(e);if(!t)throw new Error("缺少元素: ".concat(e));return t},be=()=>Z("toastContainer"),w=(e,t="success")=>{const o=be(),n=document.createElement("div");n.className="toast toast-".concat(t),n.textContent=e,o.appendChild(n),setTimeout(()=>{n.classList.add("hide")},ce-400),setTimeout(()=>{n.remove()},ce)},de=(e,t,o)=>{const n=be(),a=document.createElement("div");a.className="toast toast-info action-toast";const s=document.createElement("span");s.textContent=e;const c=document.createElement("button");return c.className="toast-action-btn",c.textContent=t,c.onclick=()=>{typeof o=="function"&&o(),a.remove()},a.appendChild(s),a.appendChild(c),n.appendChild(a),setTimeout(()=>{a.classList.add("hide"),setTimeout(()=>a.remove(),400)},3e4),a},ze=()=>{const e=Z("loadingOverlay");x+=1,e.classList.remove("hidden"),e.setAttribute("aria-hidden","false")},qe=()=>{const e=Z("loadingOverlay");x=Math.max(0,x-1),x===0&&(e.classList.add("hidden"),e.setAttribute("aria-hidden","true"))},Ke=()=>{if(z)return z;const e=document.createElement("div");return e.id="confirmOverlay",e.className="confirm-overlay hidden",e.innerHTML='\n    <div class="confirm-dialog" role="dialog" aria-modal="true">\n      <p class="confirm-message"></p>\n      <div class="confirm-actions">\n        <button type="button" class="btn btn-secondary" data-action="cancel">取消</button>\n        <button type="button" class="btn btn-primary" data-action="confirm">确认</button>\n      </div>\n    </div>\n  ',document.body.appendChild(e),z=e,e},Ge=e=>new Promise(t=>{const o=Ke(),n=o.querySelector(".confirm-message");n.textContent=e,o.classList.remove("hidden");const a=d=>{o.classList.add("hidden"),_&&(o.removeEventListener("click",_.clickHandler),document.removeEventListener("keydown",_.keyHandler),_=null),t(d)},s=d=>{const l=d.target;if(!(l instanceof HTMLElement))return;const p=l.dataset.action;p==="confirm"?a(!0):(p==="cancel"||l===o)&&a(!1)},c=d=>{d.key==="Escape"&&a(!1),d.key==="Enter"&&a(!0)};o.addEventListener("click",s),document.addEventListener("keydown",c),_={clickHandler:s,keyHandler:c}}),J="app-theme",E="dark",N="light",G=new Set,Qe=e=>{G.forEach(t=>{try{t(e)}catch(o){console.error("主题订阅回调执行失败",o)}})};function W(){const e=localStorage.getItem(J);return e===E||e===N?e:window.matchMedia("(prefers-color-scheme: dark)").matches?E:N}function Q(e){e===E?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),localStorage.setItem(J,e),Qe(e)}function Ye(){const t=W()===E?N:E;return Q(t),t}function Xe(e){return typeof e!="function"?()=>{}:(G.add(e),()=>{G.delete(e)})}function je(){const e=W();Q(e),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{localStorage.getItem(J)||(Q(t.matches?E:N),ee())})}function ee(){const e=W()===E;document.querySelectorAll(".theme-toggle-btn").forEach(o=>{const n=o.querySelector(".theme-icon-sun"),a=o.querySelector(".theme-icon-moon");n&&a&&(e?(n.classList.remove("hidden"),a.classList.add("hidden")):(n.classList.add("hidden"),a.classList.remove("hidden")))})}function Ze(){const e=document.createElement("button");return e.type="button",e.className="theme-toggle-btn border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-md px-3 py-2 hover:border-primary hover:text-primary dark:hover:border-primary dark:hover:text-primary hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 flex items-center justify-center",e.setAttribute("aria-label","切换主题"),e.title="切换深色/浅色主题",e.innerHTML='\n    <svg class="theme-icon-sun w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>\n    </svg>\n    <svg class="theme-icon-moon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>\n    </svg>\n  ',e.addEventListener("click",()=>{Ye(),ee()}),e}var le;(function(e){e.WINDOW_RESIZED="tauri://resize",e.WINDOW_MOVED="tauri://move",e.WINDOW_CLOSE_REQUESTED="tauri://close-requested",e.WINDOW_DESTROYED="tauri://destroyed",e.WINDOW_FOCUS="tauri://focus",e.WINDOW_BLUR="tauri://blur",e.WINDOW_SCALE_FACTOR_CHANGED="tauri://scale-change",e.WINDOW_THEME_CHANGED="tauri://theme-changed",e.WINDOW_CREATED="tauri://window-created",e.WEBVIEW_CREATED="tauri://webview-created",e.DRAG_ENTER="tauri://drag-enter",e.DRAG_OVER="tauri://drag-over",e.DRAG_DROP="tauri://drag-drop",e.DRAG_LEAVE="tauri://drag-leave"})(le||(le={}));async function Je(e,t){window.__TAURI_EVENT_PLUGIN_INTERNALS__.unregisterListener(e,t),await X("plugin:event|unlisten",{event:e,eventId:t})}async function et(e,t,o){var n;const a=(n=void 0)!==null&&n!==void 0?n:{kind:"Any"};return X("plugin:event|listen",{event:e,target:a,handler:$e(t)}).then(s=>async()=>Je(e,s))}const r={clients:[],currentClientId:"claude",prompts:[],selectedTags:[],recentTags:[],tagDropdownOpen:!1,tagSearchQuery:"",configContent:"",splitRatio:.5,editorMode:"edit",monacoEditor:null,editorDirty:!1,fileChangeToast:null,suppressEditorChange:!1,fileChangeUnlisten:null},i={},tt=500,ot=150,ue="splitRatio",nt=.2,rt=.8,q=1024,pe=["hover:bg-gray-400","dark:hover:bg-gray-500"],ge=["bg-gray-300","dark:bg-gray-600"],fe=["bg-primary"],y={activePromptId:null,anchorHovered:!1,tooltipHovered:!1},Le="tagFilterRecentTags",_e="configEditorMode",it=5,at="[data-tag-option]",K="https://cdn.jsdelivr.net/npm/monaco-editor@0.50.0/min",st="vs/editor/editor.main",ct=80,dt=50,lt=200,ut={ALLOWED_TAGS:["h1","h2","h3","h4","h5","h6","p","br","strong","em","u","s","ul","ol","li","blockquote","code","pre","a","img","table","thead","tbody","tr","th","td","hr","span"],ALLOWED_ATTR:["href","title","target","rel","src","alt","class"],ALLOW_DATA_ATTR:!1};let I=null,Y=!1,O=null,P=null,me=!1;const De=(e,t)=>{let o=null;const n=(...a)=>{o&&clearTimeout(o),o=window.setTimeout(()=>{o=null,e(...a)},t)};return n.cancel=()=>{o&&(clearTimeout(o),o=null)},n},D=De(({prompt:e,x:t,y:o})=>{to(e,t,o)},tt),S=De(()=>{!y.anchorHovered&&!y.tooltipHovered&&C()},ot),he=e=>Math.min(rt,Math.max(nt,e)),te=async e=>{ze();try{return await e()}finally{qe()}},pt=(e="自动快照")=>{const t=(e==null?void 0:e.trim())||"自动快照",o=new Date,n=s=>String(s).padStart(2,"0"),a="".concat(o.getFullYear(),"-").concat(n(o.getMonth()+1),"-").concat(n(o.getDate())," ").concat(n(o.getHours()),":").concat(n(o.getMinutes()));return"".concat(t," ").concat(a)},Se=async(e,t="",o="自动快照")=>{if(!e)throw new Error("缺少客户端 ID，无法创建自动快照");const n=typeof t=="string"||t!=null?t:"",a=pt(o);return await R.create(e,a,n,!0),await R.refreshTrayMenu(),console.info("[Snapshot] 自动快照已创建：".concat(a," (client: ").concat(e,")")),a},oe=()=>{r.suppressEditorChange||(r.editorDirty=!0)},gt=()=>{var e,t,o,n;i.clientDropdown=document.getElementById("clientDropdown"),i.clientDropdownToggle=document.getElementById("clientDropdownToggle"),i.clientDropdownLabel=document.getElementById("clientDropdownLabel"),i.clientDropdownPanel=document.getElementById("clientDropdownPanel"),i.clientDropdownList=document.getElementById("clientDropdownList"),i.configFileName=document.getElementById("configFileName"),i.configEditor=document.getElementById("configEditor"),i.monacoEditorContainer=document.getElementById("monacoEditorContainer"),i.markdownPreview=document.getElementById("markdownPreview"),i.markdownPreviewBody=(e=i.markdownPreview)==null?void 0:e.querySelector(".markdown-preview__body"),i.btnToggleEditorMode=document.getElementById("btnToggleEditorMode"),i.iconEditMode=document.getElementById("iconEditMode"),i.iconPreviewMode=document.getElementById("iconPreviewMode"),i.btnSaveConfig=document.getElementById("btnSaveConfig"),i.tagFilter=document.getElementById("tagFilter"),i.tagDropdownToggle=document.getElementById("tagDropdownToggle"),i.tagDropdownBadge=document.getElementById("tagDropdownBadge"),i.tagDropdownPanel=document.getElementById("tagDropdownPanel"),i.tagDropdownSearch=document.getElementById("tagDropdownSearch"),i.tagDropdownRecent=document.getElementById("tagDropdownRecent"),i.tagDropdownList=document.getElementById("tagDropdownList"),i.tagDropdownCount=document.getElementById("tagDropdownCount"),i.promptList=document.getElementById("promptList"),i.promptTooltip=document.getElementById("promptTooltip"),i.promptTooltipTitle=(t=i.promptTooltip)==null?void 0:t.querySelector(".prompt-tooltip-title"),i.promptTooltipTags=(o=i.promptTooltip)==null?void 0:o.querySelector(".prompt-tooltip-tags"),i.promptTooltipContent=(n=i.promptTooltip)==null?void 0:n.querySelector(".prompt-tooltip-content"),i.splitContainer=document.getElementById("splitContainer"),i.configSection=document.getElementById("configSection"),i.promptSection=document.getElementById("promptSection"),i.splitResizer=document.getElementById("splitResizer"),i.configEditor&&i.configEditor.addEventListener("input",oe)},ft=()=>{var e,t,o,n,a;(e=i.clientDropdownToggle)==null||e.addEventListener("click",s=>{s.stopPropagation(),Xt()}),document.addEventListener("click",s=>{const c=i.clientDropdown;c&&(c.contains(s.target)||v())}),document.addEventListener("keydown",s=>{if(s.key==="Escape"){v();return}const c=typeof s.key=="string"?s.key.toLowerCase():"";if((s.metaKey||s.ctrlKey)&&c==="s"){s.preventDefault();const l=!!s.shiftKey;F({createSnapshot:l})}}),(t=i.btnSaveConfig)==null||t.addEventListener("click",s=>{const c=!!s.shiftKey;F({createSnapshot:c})}),(o=i.btnToggleEditorMode)==null||o.addEventListener("click",()=>{const s=r.editorMode==="edit"?"preview":"edit";Oe(s)}),document.addEventListener("scroll",s=>{const c=i.promptTooltip;c&&c.contains(s.target)||C()},!0),window.addEventListener("resize",()=>{C(),r.monacoEditor&&r.monacoEditor.layout()}),(n=i.promptTooltip)==null||n.addEventListener("mouseenter",()=>{y.tooltipHovered=!0,S.cancel()}),(a=i.promptTooltip)==null||a.addEventListener("mouseleave",()=>{y.tooltipHovered=!1,S()}),_t()},mt=()=>{const e=document.getElementById("buttonTooltip");if(!e)return;let t=null,o=null;const n=()=>{o&&(o(),o=null),t=null},a=()=>{n(),e.classList.add("hidden"),e.textContent="",e.style.left="",e.style.top="",e.setAttribute("aria-hidden","true")},s=(d,l)=>{const p=e.getBoundingClientRect();let h=d+10,f=l+10;h+p.width>window.innerWidth-10&&(h=d-p.width-10),f+p.height>window.innerHeight-10&&(f=l-p.height-10),e.style.left="".concat(h,"px"),e.style.top="".concat(f,"px")},c=d=>{const l=d.target instanceof Element?d.target.closest("[data-tooltip]"):null;if(!l||l===t)return;const p=l.getAttribute("data-tooltip");if(!p)return;n(),e.textContent=p,e.classList.remove("hidden"),e.setAttribute("aria-hidden","false"),s(d.clientX,d.clientY),t=l;const h=M=>s(M.clientX,M.clientY),f=()=>{l.removeEventListener("mousemove",h),l.removeEventListener("mouseleave",f),a()};l.addEventListener("mousemove",h),l.addEventListener("mouseleave",f,{once:!0}),o=()=>{l.removeEventListener("mousemove",h),l.removeEventListener("mouseleave",f)}};document.addEventListener("mouseenter",c,!0),document.addEventListener("scroll",a,!0),document.addEventListener("pointerdown",a,!0),window.addEventListener("resize",a),document.addEventListener("visibilitychange",()=>{document.hidden&&a()})},ht=()=>new Promise((e,t)=>{if(typeof window.require=="function"&&typeof window.require.config=="function"){e(window.require);return}let o=0;const n=window.setInterval(()=>{if(o+=1,typeof window.require=="function"&&typeof window.require.config=="function"){window.clearInterval(n),e(window.require);return}o>=ct&&(window.clearInterval(n),t(new Error("Monaco Editor 加载器不可用")))},dt)}),wt=async()=>{var e;return(e=window.monaco)!=null&&e.editor?window.monaco:I||(I=ht().then(t=>new Promise((o,n)=>{try{t.config({paths:{vs:"".concat(K,"/vs")}}),window.MonacoEnvironment||(window.MonacoEnvironment={getWorkerUrl(){const a="self.MonacoEnvironment = { baseUrl: '".concat(K,"/' };\nimportScripts('").concat(K,"/vs/base/worker/workerMain.js');");return"data:text/javascript;charset=utf-8,".concat(encodeURIComponent(a))}}),t([st],()=>{var a;(a=window.monaco)!=null&&a.editor?o(window.monaco):n(new Error("Monaco Editor 未能初始化"))},a=>n(a))}catch(a){n(a)}})),I)},yt=e=>{var t;Y||!((t=e==null?void 0:e.editor)!=null&&t.defineTheme)||(e.editor.defineTheme("systemprompt-dark",{base:"vs-dark",inherit:!0,rules:[{token:"comment",foreground:"6a737d"},{token:"keyword",foreground:"f97583"},{token:"string",foreground:"9ecbff"},{token:"number",foreground:"79b8ff"}],colors:{"editor.background":"#0f172a","editor.foreground":"#e2e8f0","editor.lineHighlightBackground":"#1e293b","editorCursor.foreground":"#60a5fa","editor.selectionBackground":"#334155","editor.inactiveSelectionBackground":"#475569"}}),e.editor.defineTheme("systemprompt-light",{base:"vs",inherit:!0,rules:[{token:"comment",foreground:"6a737d"},{token:"keyword",foreground:"d73a49"},{token:"string",foreground:"032f62"},{token:"number",foreground:"005cc5"}],colors:{"editor.background":"#ffffff","editor.foreground":"#1f2933","editor.lineHighlightBackground":"#f1f5f9","editorCursor.foreground":"#0f172a","editor.selectionBackground":"#c7d2fe","editor.inactiveSelectionBackground":"#e0e7ff"}}),Y=!0)},Ae=()=>W()==="dark"?"systemprompt-dark":"systemprompt-light",ke=()=>{var e;!((e=window.monaco)!=null&&e.editor)||!Y||window.monaco.editor.setTheme(Ae())},Et=()=>{r.monacoEditor&&(r.monacoEditor.dispose(),r.monacoEditor=null)},vt=()=>{const e=i.monacoEditorContainer;if(!e)return;Et(),e.innerHTML="";const t=document.createElement("textarea");t.id="configEditorFallback",t.className="w-full h-full border-0 bg-transparent p-4 font-mono text-sm resize-none outline-none",t.placeholder="在此编辑选中客户端的配置文件",t.value=r.configContent,P&&i.configEditor&&i.configEditor.removeEventListener("input",P),e.appendChild(t),i.configEditor=t,P=o=>{r.configContent=o.target.value,r.editorMode==="preview"&&T(),oe()},t.addEventListener("input",P),w("编辑器加载失败，已切换到基础模式","warning"),k()},Ct=async()=>{if(!(r.monacoEditor||i.configEditor)&&i.monacoEditorContainer)try{const e=await wt();yt(e),r.monacoEditor=e.editor.create(i.monacoEditorContainer,{value:r.configContent,language:"markdown",theme:Ae(),automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on",fontSize:14,fontFamily:'"JetBrains Mono", "SF Mono", Consolas, "Courier New", monospace',lineNumbers:"on",renderWhitespace:"selection",bracketPairColorization:{enabled:!0}}),r.monacoEditor.onDidChangeModelContent(()=>{r.configContent=r.monacoEditor.getValue(),r.editorMode==="preview"&&T(),oe()}),ke(),k()}catch(e){console.error("Monaco Editor 初始化失败",e),vt()}},A=()=>{var e,t;return r.monacoEditor?r.monacoEditor.getValue():i.configEditor?(e=i.configEditor.value)!=null?e:"":(t=r.configContent)!=null?t:""},Me=e=>{r.suppressEditorChange=!0;try{e()}finally{r.suppressEditorChange=!1}},Ie=e=>{const t=e!=null?e:"";r.configContent=t,r.monacoEditor&&r.monacoEditor.getValue()!==t?Me(()=>{r.monacoEditor.setValue(t)}):i.configEditor&&(i.configEditor.value=t),r.editorMode==="preview"&&T()},Tt=()=>new Promise(e=>{if(window.marked&&window.DOMPurify){e(!0);return}let t=0;const o=50,n=setInterval(()=>{t++,window.marked&&window.DOMPurify?(clearInterval(n),e(!0)):t>=o&&(clearInterval(n),e(!1))},100)}),bt=()=>{!window.marked||me||(window.marked.setOptions({breaks:!0,gfm:!0}),me=!0)},T=async()=>{r.editorMode!=="preview"||!i.markdownPreviewBody||(O&&window.clearTimeout(O),i.markdownPreviewBody.innerHTML='\n    <div class="flex items-center justify-center p-8">\n      <div class="text-sm text-gray-500 dark:text-gray-400">正在加载预览...</div>\n    </div>\n  ',O=window.setTimeout(async()=>{if(O=null,!await Tt()){const o=A();console.warn("Markdown 渲染库未加载",{marked:!!window.marked,DOMPurify:!!window.DOMPurify}),i.markdownPreviewBody.innerHTML='\n        <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md">\n          <p class="text-sm text-yellow-800 dark:text-yellow-200 font-semibold mb-2">⚠️ Markdown 预览功能未就绪</p>\n          <p class="text-xs text-yellow-700 dark:text-yellow-300">marked.js 或 DOMPurify 库加载失败。请检查网络连接或浏览器控制台。</p>\n          <details class="mt-2">\n            <summary class="text-xs cursor-pointer text-yellow-600 dark:text-yellow-400">显示原始内容</summary>\n            <pre class="mt-2 text-xs bg-white dark:bg-gray-800 p-2 rounded overflow-auto max-h-96">'.concat(o||"(空)","</pre>\n          </details>\n        </div>\n      ");return}bt();const t=A();try{const o=window.marked.parse(t!=null?t:""),n=window.DOMPurify.sanitize(o,ut);i.markdownPreviewBody.innerHTML=n}catch(o){console.error("Markdown 渲染失败",o),i.markdownPreviewBody.innerHTML='<p class="text-sm text-red-500">Markdown 渲染失败: '+o.message+"</p>"}},lt))},Lt=()=>{const e=r.editorMode==="preview";i.iconEditMode&&i.iconPreviewMode&&(e?(i.iconEditMode.classList.add("hidden"),i.iconPreviewMode.classList.remove("hidden")):(i.iconEditMode.classList.remove("hidden"),i.iconPreviewMode.classList.add("hidden"))),i.btnToggleEditorMode&&(i.btnToggleEditorMode.setAttribute("data-tooltip",e?"编辑":"预览"),i.btnToggleEditorMode.setAttribute("aria-label",e?"切换到编辑模式":"切换到预览模式"))},Oe=e=>{var o,n,a,s,c,d;if(!e||e!=="edit"&&e!=="preview")return;r.editorMode!==e&&(r.editorMode=e,Gt()),e==="preview"?((o=i.monacoEditorContainer)==null||o.classList.add("hidden"),(n=i.markdownPreview)==null||n.classList.remove("hidden"),(a=i.btnSaveConfig)==null||a.classList.add("hidden"),T()):((s=i.markdownPreview)==null||s.classList.add("hidden"),(c=i.monacoEditorContainer)==null||c.classList.remove("hidden"),(d=i.btnSaveConfig)==null||d.classList.remove("hidden"),r.monacoEditor&&r.monacoEditor.layout()),Lt()},_t=()=>{var e,t,o,n,a;(e=i.tagDropdownToggle)==null||e.addEventListener("click",()=>Dt()),(t=i.tagDropdownSearch)==null||t.addEventListener("input",kt),(o=i.tagDropdownSearch)==null||o.addEventListener("keydown",Mt),(n=i.tagDropdownPanel)==null||n.addEventListener("click",It),(a=i.tagDropdownPanel)==null||a.addEventListener("keydown",Ot),document.addEventListener("click",St),document.addEventListener("keydown",At)},Dt=e=>{const t=i.tagDropdownToggle,o=i.tagDropdownPanel;if(!t||!o||t.disabled)return;const n=!r.tagDropdownOpen;r.tagDropdownOpen!==n&&(r.tagDropdownOpen=n,ne())},b=()=>{r.tagDropdownOpen&&(r.tagDropdownOpen=!1),ne()},ne=()=>{const e=i.tagDropdownPanel,t=i.tagDropdownToggle;if(!e||!t)return;const o=!!r.tagDropdownOpen&&!t.disabled;e.classList.toggle("is-open",o),e.setAttribute("aria-hidden",String(!o)),t.setAttribute("aria-expanded",String(o)),o?window.requestAnimationFrame(()=>{i.tagDropdownSearch&&!i.tagDropdownSearch.disabled&&i.tagDropdownSearch.focus({preventScroll:!0})}):document.activeElement&&e.contains(document.activeElement)&&typeof t.focus=="function"&&t.focus()},St=e=>{if(!r.tagDropdownOpen||!i.tagFilter)return;const t=e.target;t instanceof Node&&(i.tagFilter.contains(t)||b())},At=e=>{e.key==="Escape"&&r.tagDropdownOpen&&(e.preventDefault(),b())},kt=e=>{var t,o;r.tagSearchQuery=(o=(t=e==null?void 0:e.target)==null?void 0:t.value)!=null?o:"",H()},Mt=e=>{r.tagDropdownOpen&&(e.key==="ArrowDown"?(e.preventDefault(),B(1)):e.key==="ArrowUp"?(e.preventDefault(),B(-1)):e.key==="Escape"&&(e.preventDefault(),b()))},It=e=>{const t=e.target;if(!(t instanceof Element))return;const o=t.closest(at);if(!o||o.getAttribute("aria-disabled")==="true"||o.disabled)return;const n=o.dataset.tagOption;n&&Yt(n)},Ot=e=>{var t;r.tagDropdownOpen&&((t=i.tagDropdownSearch)!=null&&t.contains(e.target)||(e.key==="ArrowDown"?(e.preventDefault(),B(1)):e.key==="ArrowUp"?(e.preventDefault(),B(-1)):e.key==="Escape"&&(e.preventDefault(),b())))},Pt=()=>i.tagDropdownPanel?Array.from(i.tagDropdownPanel.querySelectorAll(".tag-dropdown__option:not([disabled])")):[],B=(e=1)=>{const t=Pt();if(!t.length)return;const o=document.activeElement;let n=t.indexOf(o);n===-1&&(n=e>0?-1:t.length);const a=(n+e+t.length)%t.length,s=t[a];s&&s.focus()},xt=()=>{const e=i.splitContainer,t=i.configSection,o=i.promptSection,n=i.splitResizer;if(!e||!t||!o||!n)return;const a=(()=>{try{const m=localStorage.getItem(ue);if(m!==null){const g=parseFloat(m);if(Number.isFinite(g))return he(g)}}catch(m){}return null})();a!==null&&(r.splitRatio=a);let s=null,c=!1;const d=()=>{s||(s=window.requestAnimationFrame(()=>{s=null,l()}))},l=()=>{if(window.innerWidth<q){t.style.removeProperty("width"),o.style.removeProperty("width");return}t.style.width="".concat(r.splitRatio*100,"%"),o.style.width="".concat((1-r.splitRatio)*100,"%"),r.monacoEditor&&r.monacoEditor.layout()},p=()=>{try{localStorage.setItem(ue,String(r.splitRatio))}catch(m){}},h=m=>{document.body&&document.body.classList.toggle("select-none",m)},f=m=>{m?(fe.forEach(g=>n.classList.add(g)),ge.forEach(g=>n.classList.remove(g)),pe.forEach(g=>n.classList.remove(g))):(fe.forEach(g=>n.classList.remove(g)),ge.forEach(g=>n.classList.add(g)),pe.forEach(g=>n.classList.add(g)))},M=m=>{if(typeof m!="number")return;const g=e.getBoundingClientRect();if(g.width<=0)return;const He=m-g.left,V=he(He/g.width);!Number.isFinite(V)||Math.abs(V-r.splitRatio)<.001||(r.splitRatio=V,d())},se=m=>{c&&(m.preventDefault(),M(m.clientX))},U=()=>{c&&(c=!1,h(!1),f(!1),window.removeEventListener("mousemove",se),window.removeEventListener("mouseup",U),p())},Fe=m=>{m.button===0&&(window.innerWidth<q||(m.preventDefault(),c=!0,h(!0),f(!0),window.addEventListener("mousemove",se),window.addEventListener("mouseup",U)))},We=()=>{c&&window.innerWidth<q&&U(),d()};n.addEventListener("mousedown",Fe),window.addEventListener("resize",We),l()},Rt=async()=>{je(),Xe(()=>{ke(),r.editorMode==="preview"&&T()});const e=document.getElementById("themeToggleContainer");e&&(e.appendChild(Ze()),ee()),gt(),mt(),qt(),Kt(),ft(),Oe(r.editorMode),xt();try{if(await te(async()=>{await Ct(),await Nt(),await Bt(),await Ft(),await re(r.currentClientId)}),Ne(),H(),ae(),r.currentClientId)try{const t=await j.read(r.currentClientId);await Se(r.currentClientId,t!=null?t:"","启动时自动快照")}catch(t){console.warn("创建启动快照失败:",t)}await Ht(),await Pe(r.currentClientId)}catch(t){w(L(t)||"初始化失败","error")}},Nt=async()=>{const e=await Ve.getAll();if(r.clients=Array.isArray(e)?e:[],!r.clients.length)throw new Error("尚未配置任何客户端")},Bt=async()=>{try{const e=await Te.get();e!=null&&e.current_client_id&&(r.currentClientId=e.current_client_id)}catch(e){w(L(e)||"加载应用状态失败，已使用默认客户端","warning")}r.clients.some(e=>e.id===r.currentClientId)||(r.currentClientId=r.clients[0].id)},Ft=async()=>{try{const e=await Ue.getAll();r.prompts=Array.isArray(e)?e:[]}catch(e){throw new Error(L(e)||"加载提示词失败")}},re=async e=>{if(!e)return!1;let t=!0;try{console.log("[LoadConfig] Reading config for client: ".concat(e));const o=await j.read(e);r.configContent=o!=null?o:"",console.log("[LoadConfig] Content loaded, length: ".concat(r.configContent.length))}catch(o){t=!1,r.configContent="",w(L(o)||"读取配置文件失败","error")}return console.log("[LoadConfig] Syncing editor..."),ao(),r.editorDirty=!1,console.log("[LoadConfig] Editor synced, dirty flag cleared"),t},Pe=async e=>{var n;if(!e)return;const t=(n=window.__TAURI_INTERNALS__)==null?void 0:n.invoke;if(typeof t!="function")return;const o=r.clients.find(a=>a.id===e);if(o!=null&&o.config_file_path)try{await t("start_watching_config",{filePath:o.config_file_path}),console.log("[FileWatcher] Started watching: ".concat(o.config_file_path))}catch(a){console.warn("[FileWatcher] Failed to start watching:",a)}},xe=async()=>{var t;const e=(t=window.__TAURI_INTERNALS__)==null?void 0:t.invoke;if(typeof e=="function")try{await e("stop_watching_config"),console.log("[FileWatcher] Stopped watching")}catch(o){console.warn("[FileWatcher] Failed to stop watching:",o)}},ie=()=>{r.fileChangeToast&&(r.fileChangeToast.remove(),r.fileChangeToast=null)},we=async()=>{if(console.log("[Reload] Starting config file reload..."),!r.currentClientId){console.warn("[Reload] No current client ID");return}await re(r.currentClientId)?(ie(),console.log("[Reload] Config reloaded successfully"),w("配置已重新加载","success")):(console.error("[Reload] Config reload failed"),w("重新加载失败","error"))},Wt=async()=>{console.log("[FileChange] Config file changed, editorDirty: ".concat(r.editorDirty)),ie(),r.editorDirty?(console.log("[FileChange] Showing toast with confirmation (has unsaved changes)"),r.fileChangeToast=de("配置文件已在外部修改","重新加载",async()=>{console.log("[FileChange] User clicked reload button (with unsaved changes)");const e=await Ge("配置文件已在外部修改，是否重新加载？（将丢失未保存的修改）");console.log("[FileChange] User confirmed: ".concat(e)),e&&await we()})):(console.log("[FileChange] Showing toast (no unsaved changes)"),r.fileChangeToast=de("配置文件已更新","重新加载",async()=>{console.log("[FileChange] User clicked reload button"),await we()}))},Ht=async()=>{if(console.log("[FileWatcher] listenToFileChanges() called"),r.fileChangeUnlisten){console.log("[FileWatcher] Already listening, skipping...");return}console.log("[FileWatcher] Registering config-file-changed listener...");try{r.fileChangeUnlisten=await et("config-file-changed",async e=>{console.log("[FileWatcher] Config file changed:",e.payload);try{await Wt()}catch(t){console.warn("[FileWatcher] Failed to process config change:",t)}}),console.log("[FileWatcher] Listener registered successfully!")}catch(e){console.error("[FileWatcher] Failed to register listener:",e)}},$t=()=>{typeof r.fileChangeUnlisten=="function"&&(r.fileChangeUnlisten(),r.fileChangeUnlisten=null)},F=async({silent:e=!1,createSnapshot:t=!1}={})=>{if(!r.currentClientId)return!1;const o=A();r.configContent=o;try{if(await te(async()=>{await j.write(r.currentClientId,r.configContent)}),r.editorDirty=!1,e||w("配置已保存","success"),t){const n=prompt("请输入快照名称（留空取消）："),a=n==null?void 0:n.trim();if(a)try{await R.create(r.currentClientId,a,o!=null?o:"",!1),await R.refreshTrayMenu(),console.info("[Snapshot] 手动快照已创建：".concat(a," (client: ").concat(r.currentClientId,")")),w("快照「".concat(a,"」已创建"),"success")}catch(s){console.warn("手动创建快照失败:",s),w("创建快照失败","error")}}return!0}catch(n){return w(L(n)||"保存配置失败","error"),!1}},Ut=async e=>{if(e===r.currentClientId)return;const t=r.currentClientId;if(t)try{const o=A();await Se(t,o,"自动保存")}catch(o){console.warn("切换客户端时保存快照失败:",o)}r.currentClientId=e,r.selectedTags=[],r.tagSearchQuery="",ie(),b(),v(),Ne(),H(),ae();try{await xe(),await te(async()=>{await Te.setCurrentClient(e),await re(e)}),await Pe(e)}catch(o){w(L(o)||"切换客户端失败","error")}},Vt=async e=>{var n;const t=r.prompts.find(a=>a.id===e);if(!t){w("未找到提示词","error");return}Ie((n=t.content)!=null?n:""),await F({silent:!0})&&w("已应用提示词「".concat(t.name,"」"),"success")},zt=async e=>{var c;const t=r.prompts.find(d=>d.id===e);if(!t){w("未找到提示词","error");return}const o=A(),n=o.trim().length>0,a="".concat(o).concat(n?"\n\n":"").concat((c=t.content)!=null?c:"");Ie(a),await F({silent:!0})&&w("已追加提示词「".concat(t.name,"」"),"success")},ye=(e,t)=>{var n;if(!Array.isArray(e)||!e.length)return[];const o=(n=t==null?void 0:t.trim())==null?void 0:n.toLowerCase();return o?e.filter(a=>a.toLowerCase().includes(o)):[...e]},qt=()=>{try{const e=localStorage.getItem(Le);if(!e){r.recentTags=[];return}const t=JSON.parse(e);r.recentTags=Array.isArray(t)?t.filter(o=>typeof o=="string"&&o.trim()):[]}catch(e){r.recentTags=[]}},Re=()=>{try{localStorage.setItem(Le,JSON.stringify(r.recentTags))}catch(e){}},Kt=()=>{try{const e=localStorage.getItem(_e);(e==="edit"||e==="preview")&&(r.editorMode=e)}catch(e){}},Gt=()=>{try{localStorage.setItem(_e,r.editorMode)}catch(e){}},Qt=e=>{if(typeof e!="string"||!e.trim())return;const t=e.trim(),o=[t,...r.recentTags.filter(n=>n!==t)];r.recentTags=o.slice(0,it),Re()},Yt=e=>{if(!e)return;const t=r.selectedTags.indexOf(e);let o=!1;t>=0?r.selectedTags.splice(t,1):(r.selectedTags.push(e),o=!0),o&&Qt(e),H(),ae()},Ne=()=>{const e=i.clientDropdownList,t=i.clientDropdownToggle;if(!e||!t)return;e.innerHTML="";const o=r.clients.length>0;if(t.disabled=!o,!o){t.setAttribute("aria-disabled","true"),Ee(),v(),k();return}t.removeAttribute("aria-disabled");const n=document.createDocumentFragment();r.clients.forEach(a=>{const s=document.createElement("button");s.type="button",s.className="client-dropdown__option",s.textContent=a.name,s.dataset.clientId=a.id,s.setAttribute("role","option");const c=a.id===r.currentClientId;s.setAttribute("aria-selected",String(c)),s.addEventListener("click",()=>{if(a.id===r.currentClientId){v();return}Ut(a.id)}),n.appendChild(s)}),e.appendChild(n),Ee(),k()},Ee=()=>{const e=i.clientDropdownLabel;if(!e)return;const t=$();e.textContent=t?t.name:"选择客户端"},Xt=()=>{const e=i.clientDropdownToggle,t=i.clientDropdownPanel;if(!e||!t||e.disabled)return;t.getAttribute("aria-hidden")==="false"?v():(t.setAttribute("aria-hidden","false"),e.setAttribute("aria-expanded","true"))},v=()=>{const e=i.clientDropdownToggle,t=i.clientDropdownPanel;!e||!t||(t.setAttribute("aria-hidden","true"),e.setAttribute("aria-expanded","false"))},H=()=>{var h;const e=i.tagDropdownToggle,t=i.tagDropdownSearch;if(!e||!i.tagDropdownPanel)return;const o=ro(),n=o.length>0,a=new Set(Be()),s=new Set(r.selectedTags);let c=!!((h=r.tagSearchQuery)!=null&&h.trim());if(e.disabled=!n,e.setAttribute("aria-disabled",String(!n)),e.classList.toggle("is-disabled",!n),n?e.removeAttribute("title"):(e.title="暂无可用标签",r.tagSearchQuery="",b(),c=!1),t&&(t.disabled=!n,t.value!==r.tagSearchQuery&&(t.value=r.tagSearchQuery),t.placeholder=n?"搜索标签...":"暂无可用标签"),i.tagDropdownBadge){const f=r.selectedTags.length;i.tagDropdownBadge.textContent=String(f),i.tagDropdownBadge.classList.toggle("hidden",f===0)}const d=n?ye(o,r.tagSearchQuery):[],l=n?r.recentTags.filter(f=>o.includes(f)):[];n&&l.length!==r.recentTags.length&&(r.recentTags=l,Re());const p=ye(l,r.tagSearchQuery);ve(i.tagDropdownList,d,{autoTags:a,selectedTagSet:s,emptyLabel:n&&c?"无匹配标签":"暂无标签"}),ve(i.tagDropdownRecent,p,{autoTags:a,selectedTagSet:s,emptyLabel:c?"最近使用无匹配标签":"暂无最近使用"}),i.tagDropdownCount&&(n?c?i.tagDropdownCount.textContent="匹配 ".concat(d.length," / ").concat(o.length):i.tagDropdownCount.textContent="共 ".concat(o.length," 个"):i.tagDropdownCount.textContent=""),ne()},ve=(e,t,{autoTags:o,selectedTagSet:n,emptyLabel:a})=>{if(!e)return;if(e.innerHTML="",!t.length){if(a){const c=document.createElement("p");c.className="tag-dropdown__empty",c.textContent=a,e.appendChild(c)}return}const s=document.createDocumentFragment();t.forEach(c=>{s.appendChild(jt(c,{isAuto:o.has(c),isActive:o.has(c)||n.has(c)}))}),e.appendChild(s)},jt=(e,{isAuto:t,isActive:o})=>{const n=document.createElement("button");n.type="button",n.className="tag-dropdown__option",n.dataset.tagOption=e,n.setAttribute("role","option"),n.setAttribute("aria-selected",String(!!o)),o&&n.classList.add("is-active"),t&&(n.disabled=!0,n.setAttribute("aria-disabled","true"),n.classList.add("is-auto"),n.title="由当前客户端自动应用");const a=document.createElement("span");if(a.className="tag-dropdown__option-label",a.textContent=e,n.appendChild(a),t){const s=document.createElement("span");s.className="tag-dropdown__option-meta",s.textContent="自动",n.appendChild(s)}return n},ae=()=>{const e=i.promptList;if(!e)return;e.setAttribute("role","list"),C(),e.innerHTML="";const t=no();if(!t.length){const n=document.createElement("div");n.className="empty-state",n.textContent="暂无符合条件的提示词",e.appendChild(n);return}const o=document.createDocumentFragment();t.forEach(n=>{o.appendChild(Zt(n))}),e.appendChild(o)},Zt=e=>{var a;const t=document.createElement("div");t.className="prompt-list-item",t.dataset.promptId=String((a=e.id)!=null?a:""),t.setAttribute("role","listitem");const o=document.createElement("span");o.className="prompt-item-title",o.textContent=e.name||"未命名提示词",t.appendChild(o);const n=document.createElement("div");return n.className="prompt-item-actions",n.appendChild(Ce("apply","应用提示词",()=>Vt(e.id))),n.appendChild(Ce("append","追加提示词",()=>zt(e.id))),t.appendChild(n),Jt(o,e),t},Ce=(e,t,o)=>{const n=document.createElement("button");n.type="button",n.className="prompt-action-btn prompt-action-".concat(e),n.setAttribute("aria-label",t),n.setAttribute("data-tooltip",t);const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("class","w-4 h-4"),a.setAttribute("viewBox","0 0 24 24"),a.setAttribute("fill","none"),a.setAttribute("stroke","currentColor"),a.setAttribute("stroke-width","2");const s=document.createElementNS("http://www.w3.org/2000/svg","path");return e==="apply"?s.setAttribute("d","M5 3l14 9-14 9V3z"):e==="append"&&s.setAttribute("d","M12 5v14m-7-7h14"),a.appendChild(s),n.appendChild(a),n.addEventListener("click",()=>{C(),o()}),n},Jt=(e,t)=>{e.addEventListener("mouseenter",o=>{y.anchorHovered=!0,S.cancel(),D({prompt:t,x:o.clientX,y:o.clientY})}),e.addEventListener("mousemove",o=>{y.anchorHovered=!0,eo(t.id)||D({prompt:t,x:o.clientX,y:o.clientY})}),e.addEventListener("mouseleave",()=>{y.anchorHovered=!1,D.cancel(),S()}),e.addEventListener("touchstart",()=>{D.cancel(),C()},{passive:!0})},eo=e=>{const t=i.promptTooltip;return!t||t.classList.contains("hidden")?!1:e?y.activePromptId===e:!0},to=(e,t,o)=>{var a,s;const n=i.promptTooltip;if(n){if(y.activePromptId=e.id,n.dataset.promptId=String((a=e.id)!=null?a:""),i.promptTooltipTitle&&(i.promptTooltipTitle.textContent=e.name||"未命名提示词"),i.promptTooltipTags){i.promptTooltipTags.innerHTML="";const c=Array.isArray(e.tags)?e.tags:[];if(c.length)c.forEach(d=>{const l=document.createElement("span");l.className="prompt-tooltip-tag",l.textContent=d,i.promptTooltipTags.appendChild(l)});else{const d=document.createElement("span");d.className="prompt-tooltip-tag muted",d.textContent="无标签",i.promptTooltipTags.appendChild(d)}}i.promptTooltipContent&&(i.promptTooltipContent.textContent=(s=e.content)!=null?s:""),n.classList.remove("hidden"),n.setAttribute("aria-hidden","false"),oo(t,o)}},C=()=>{D.cancel(),S.cancel();const e=i.promptTooltip;e&&(e.classList.add("hidden"),e.setAttribute("aria-hidden","true"),y.activePromptId=null,y.anchorHovered=!1,y.tooltipHovered=!1,delete e.dataset.promptId)},oo=(e=0,t=0)=>{const o=i.promptTooltip;if(!o)return;const n=18,a=10,s=12,c=o.offsetWidth,d=o.offsetHeight;let l=e+n,p=t+a;const h=window.innerWidth-c-s,f=window.innerHeight-d-s;l=Math.min(Math.max(s,l),Math.max(s,h)),p=Math.min(Math.max(s,p),Math.max(s,f)),o.style.left="".concat(l,"px"),o.style.top="".concat(p,"px")},no=()=>{const e=io();return e.length?r.prompts.filter(t=>e.every(o=>{var n;return((n=t.tags)!=null?n:[]).includes(o)})):r.prompts},ro=()=>{const e=new Set;return r.prompts.forEach(t=>{var o;((o=t.tags)!=null?o:[]).forEach(n=>{n!=null&&n.trim()&&e.add(n)})}),Array.from(e).sort((t,o)=>t.localeCompare(o,"zh-CN"))},Be=()=>{const e=$();return e!=null&&e.auto_tag?[e.id]:[]},io=()=>{const e=[...Be(),...r.selectedTags];return e.length?Array.from(new Set(e)):[]},$=()=>r.clients.find(e=>e.id===r.currentClientId),ao=()=>{var e;if(r.monacoEditor){const t=r.monacoEditor.getValue();console.log("[SyncEditor] Monaco editor current length: ".concat(t.length,", new length: ").concat(r.configContent.length)),r.configContent!==t?(console.log("[SyncEditor] Updating Monaco editor value"),Me(()=>{var o;r.monacoEditor.setValue((o=r.configContent)!=null?o:"")}),console.log("[SyncEditor] Monaco editor updated")):console.log("[SyncEditor] Monaco editor content unchanged, skipping update")}else i.configEditor&&(console.log("[SyncEditor] Using fallback editor, length: ".concat(r.configContent.length)),i.configEditor.value=(e=r.configContent)!=null?e:"");k(),so(),r.editorMode==="preview"&&(console.log("[SyncEditor] Rendering preview"),T())},so=()=>{if(!i.configFileName)return;const e=$();if(!e){i.configFileName.textContent="未选择客户端";return}const t=e.config_file_path||"",o=t.split(/[/\\]/).filter(Boolean).pop();i.configFileName.textContent=o||t||e.name},k=()=>{const e=!!$();r.monacoEditor&&r.monacoEditor.updateOptions({readOnly:!e}),i.configEditor&&(i.configEditor.disabled=!e),i.btnSaveConfig&&(i.btnSaveConfig.disabled=!e)},L=e=>typeof e=="string"?e:e==null?void 0:e.message;window.addEventListener("beforeunload",()=>{xe(),$t()});document.addEventListener("DOMContentLoaded",Rt);export{co as __vite_legacy_guard};
